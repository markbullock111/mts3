<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Offline Attendance Admin</title>
  <link rel="stylesheet" href="/ui/styles.css" />
</head>
<body>
  <header class="topbar">
    <div>
      <h1>Offline Attendance Admin</h1>
      <p>Single-entrance morning check-in (offline local server)</p>
    </div>
    <div class="health" id="healthBadge">Checking backend...</div>
  </header>

  <nav class="tabs">
    <button data-tab="attendance" class="active">Attendance</button>
    <button data-tab="employees">Employees</button>
    <button data-tab="settings">Settings</button>
  </nav>

  <main>
    <section id="tab-attendance" class="tab active">
      <div class="card">
        <div class="row-between wrap">
          <h2>Attendance Dashboard</h2>
          <div class="controls">
            <label>Date <input type="date" id="eventsDate" /></label>
            <button id="attendanceTodayBtn" type="button" class="secondary-btn">Today</button>
            <button id="loadEventsBtn">Load In New Tab</button>
            <button id="refreshTodayBtn" type="button">Refresh Today</button>
            <button id="exportCsvBtn">Export CSV</button>
            <label><input type="checkbox" id="attendanceAutoRefresh" checked /> Auto Refresh (5s)</label>
          </div>
        </div>
        <div class="metrics" id="attendanceMetrics">
          <div class="metric-card">
            <div class="metric-label">Rows</div>
            <div id="attendanceMetricRows" class="metric-value">0</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Recognized</div>
            <div id="attendanceMetricRecognized" class="metric-value">0</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Unknown</div>
            <div id="attendanceMetricUnknown" class="metric-value">0</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">On Time</div>
            <div id="attendanceMetricOnTime" class="metric-value metric-value-ok">0</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Late</div>
            <div id="attendanceMetricLate" class="metric-value metric-value-late">0</div>
          </div>
        </div>
        <div class="row-between wrap">
          <div class="controls">
            <label>Today's Attendance Time (UTC) <input type="time" id="todayAttendanceTimeInput" step="60" /></label>
            <button id="saveTodayAttendanceTimeBtn" type="button">Save Today Time</button>
            <button id="clearTodayAttendanceTimeBtn" type="button">Use Standard</button>
          </div>
          <div id="attendanceTimeInfo" class="muted"></div>
        </div>
        <p class="hint">Today list includes recognized employees and unknown detections. Click image thumbnail to open full picture.</p>
        <div class="row-between wrap">
          <h3 id="attendanceSummaryTitle">Today's Check-in List</h3>
          <div class="controls">
            <label>Filter
              <input id="attendanceSummarySearchInput" type="text" placeholder="name / code / method / status" />
            </label>
            <button id="clearAttendanceSearchBtn" type="button" class="secondary-btn">Clear</button>
            <label>Sort By
              <select id="attendanceSummarySortBy">
                <option value="time">Time</option>
                <option value="name">Name</option>
              </select>
            </label>
            <label>Order
              <select id="attendanceSummarySortDir">
                <option value="asc">Asc</option>
                <option value="desc">Desc</option>
              </select>
            </label>
          </div>
        </div>
        <div class="table-wrap">
          <table id="attendanceSummaryTable">
            <thead>
              <tr>
                <th>Name</th><th>Code</th><th>Entrance Time (UTC)</th><th>Method</th><th>Confidence</th><th>Status</th><th>Picture</th><th>Override</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <datalist id="attendanceEmployeeOptions"></datalist>
      </div>
    </section>

    <section id="tab-employees" class="tab">
      <div class="card">
        <div class="row-between wrap">
          <h2>Employees</h2>
          <div class="controls">
            <button id="openAddEmployeePageBtn" type="button">Add Employee</button>
            <button id="openEnrollmentPageBtn" type="button" class="secondary-btn">Enrollment</button>
            <label>Search
              <input id="employeesSearchInput" type="text" placeholder="Search by name / ID / code" />
            </label>
            <label>Sort By
              <select id="employeesSortBy">
                <option value="id">ID</option>
                <option value="name">Name</option>
                <option value="code">Code</option>
                <option value="status">Status</option>
              </select>
            </label>
            <label>Order
              <select id="employeesSortDir">
                <option value="asc">Asc</option>
                <option value="desc">Desc</option>
              </select>
            </label>
            <button id="clearEmployeesSearchBtn" type="button" class="secondary-btn">Clear</button>
            <button id="refreshEmployeesBtn" type="button" class="secondary-btn">Refresh</button>
          </div>
        </div>
        <p class="hint">Search supports employee name, employee ID, or employee code. Use View for full profile/history/photos.</p>
        <div id="employeesStats" class="muted"></div>
        <div class="table-wrap">
          <table id="employeesTable">
            <thead>
              <tr>
                <th>ID</th><th>Code</th><th>Name</th><th>Main Picture</th><th>Birth</th><th>Job</th><th>Status</th><th>Face</th><th>ReID</th><th>Photos</th><th>Details</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="tab-settings" class="tab">
      <div class="card">
        <div class="row-between">
          <h2>System Settings</h2>
          <button id="reloadSettingsBtn" class="secondary-btn">Reload</button>
        </div>
        <p class="hint">Update matching thresholds, attendance time policy, and entry geometry.</p>
        <form id="settingsForm" class="grid-form">
          <label>Face Threshold <input type="number" step="0.01" name="face_threshold" /></label>
          <label>ReID Threshold <input type="number" step="0.01" name="reid_threshold" /></label>
          <label>Standard Attendance Time (UTC) <input type="time" name="standard_attendance_time" /></label>
          <label>Morning Start <input type="time" name="morning_window_start" /></label>
          <label>Morning End <input type="time" name="morning_window_end" /></label>
          <label>Snapshot Retention Days <input type="number" min="0" name="snapshot_retention_days" /></label>
          <label>Save Snapshots Default
            <select name="save_snapshots_default">
              <option value="false">false</option>
              <option value="true">true</option>
            </select>
          </label>
          <details class="full advanced-settings" open>
            <summary>Advanced Geometry (ROI/Entry Line)</summary>
            <div class="grid-form">
              <label class="full">ROI Polygon (JSON)
                <textarea name="roi_polygon" rows="4"></textarea>
              </label>
              <label class="full">Entry Line (JSON)
                <textarea name="entry_line" rows="3"></textarea>
              </label>
            </div>
          </details>
          <button type="submit">Save Settings</button>
        </form>
        <pre id="settingsResult" class="output"></pre>
      </div>

      <div class="card">
        <h2>Add Camera</h2>
        <form id="cameraForm" class="grid-form">
          <label>Name <input name="name" required placeholder="Entrance Camera 1" /></label>
          <label>Camera Source <input name="rtsp_url" required placeholder="rtsp://... or webcam / webcam:0 / 0 / 1" /></label>
          <label>Location <input name="location" placeholder="Main Gate" /></label>
          <label>Enabled
            <select name="enabled">
              <option value="true">true</option>
              <option value="false">false</option>
            </select>
          </label>
          <button type="submit">Add Camera</button>
        </form>
      </div>

      <div class="card">
        <div class="row-between wrap">
          <h2>Camera Data</h2>
          <button id="refreshCamerasBtn" type="button" class="secondary-btn">Refresh</button>
        </div>
        <p class="hint">Use RTSP URL for IP camera, or webcam source like <code>webcam</code>, <code>webcam:0</code>, <code>0</code>, <code>1</code>.</p>
        <div class="table-wrap">
          <table id="camerasTable">
            <thead>
              <tr>
                <th>ID</th><th>Name</th><th>RTSP URL</th><th>Location</th><th>Enabled</th><th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="row-between wrap">
          <h2>Live Camera View</h2>
          <button id="stopCameraPreviewBtn" type="button" class="secondary-btn">Stop View</button>
        </div>
        <p id="cameraPreviewHint" class="hint">Click <code>View</code> in Camera Data to show live stream with colored person rectangles and names.</p>
        <div class="camera-preview-wrap">
          <img id="cameraPreviewImg" alt="Camera live view" />
        </div>
      </div>
    </section>
  </main>

  <script src="/ui/app.js"></script>
</body>
</html>
