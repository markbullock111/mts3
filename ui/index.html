<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Offline Attendance Admin</title>
  <link rel="stylesheet" href="/ui/styles.css" />
</head>
<body>
  <header class="topbar">
    <div>
      <h1>Offline Attendance Admin</h1>
      <p>Single-entrance morning check-in (offline local server)</p>
    </div>
    <div class="health" id="healthBadge">Checking backend...</div>
  </header>

  <nav class="tabs">
    <button data-tab="attendance" class="active">Attendance</button>
    <button data-tab="employees">Employees</button>
    <button data-tab="enrollment">Enrollment</button>
    <button data-tab="settings">Settings</button>
  </nav>

  <main>
    <section id="tab-attendance" class="tab active">
      <div class="card">
        <div class="row-between wrap">
          <h2>Attendance Dashboard</h2>
          <div class="controls">
            <label>Date <input type="date" id="eventsDate" /></label>
            <button id="loadEventsBtn">Load In New Tab</button>
            <button id="refreshTodayBtn" type="button">Refresh Today</button>
            <button id="exportCsvBtn">Export CSV</button>
            <label><input type="checkbox" id="attendanceAutoRefresh" checked /> Auto Refresh (5s)</label>
          </div>
        </div>
        <div class="row-between wrap">
          <div class="controls">
            <label>Today's Attendance Time (UTC) <input type="time" id="todayAttendanceTimeInput" step="60" /></label>
            <button id="saveTodayAttendanceTimeBtn" type="button">Save Today Time</button>
            <button id="clearTodayAttendanceTimeBtn" type="button">Use Standard</button>
          </div>
          <div id="attendanceTimeInfo" class="muted"></div>
        </div>
        <p class="hint">Today list includes recognized employees and unknown detections. Click image thumbnail to open full picture.</p>
        <div class="row-between wrap">
          <h3 id="attendanceSummaryTitle">Today's Check-in List</h3>
          <div class="controls">
            <label>Sort By
              <select id="attendanceSummarySortBy">
                <option value="time">Time</option>
                <option value="name">Name</option>
              </select>
            </label>
            <label>Order
              <select id="attendanceSummarySortDir">
                <option value="asc">Asc</option>
                <option value="desc">Desc</option>
              </select>
            </label>
          </div>
        </div>
        <table id="attendanceSummaryTable">
          <thead>
            <tr>
              <th>Name</th><th>Code</th><th>Entrance Time (UTC)</th><th>Method</th><th>Confidence</th><th>Status</th><th>Picture</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="card">
        <div class="row-between wrap">
          <h2>Unknown Events Review (Selected Date)</h2>
          <div class="controls">
            <button id="loadUnknownsBtn" type="button">Load Unknowns</button>
          </div>
        </div>
        <p class="hint">Use selected Attendance date, then assign unknown events to employee IDs.</p>
        <table id="unknownsTable">
          <thead>
            <tr>
              <th>ID</th><th>Time</th><th>Method</th><th>Conf</th><th>Track</th><th>Assign Employee ID</th><th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="tab-employees" class="tab">
      <div class="card">
        <div class="row-between wrap">
          <h2>Employees</h2>
          <div class="controls">
            <button id="openAddEmployeePageBtn" type="button">Add Employee</button>
            <label>Search
              <input id="employeesSearchInput" type="text" placeholder="Search by name / ID / code" />
            </label>
            <button id="clearEmployeesSearchBtn" type="button">Clear</button>
            <button id="refreshEmployeesBtn" type="button">Refresh</button>
          </div>
        </div>
        <p class="hint">Search supports employee name, employee ID, or employee code.</p>
        <table id="employeesTable">
          <thead>
            <tr>
              <th>ID</th><th>Code</th><th>Name</th><th>Birth</th><th>Job</th><th>Status</th><th>Face</th><th>ReID</th><th>Photos</th><th>Details</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="tab-enrollment" class="tab">
      <div class="card">
        <h2>Enrollment Workflow</h2>
        <form id="faceEnrollForm" class="grid-form">
          <label>Employee ID <input type="number" name="employee_id" min="1" required /></label>
          <label>Mode
            <select name="kind">
              <option value="face">Face</option>
              <option value="reid">ReID</option>
            </select>
          </label>
          <label class="full">Upload Photos <input type="file" name="files" accept="image/*" multiple required /></label>
          <button id="enrollSubmitBtn" type="submit">Upload Enrollment Images</button>
        </form>
        <div id="enrollUploadStatus" class="upload-status hidden" aria-live="polite">
          <span class="spinner" aria-hidden="true"></span>
          <span id="enrollUploadStatusText">Uploading...</span>
        </div>
        <p id="enrollTargetInfo" class="hint">Employee ID will be shown during upload.</p>
        <p class="hint">Face enrollment: upload at least 5 photos per employee (different angles/lighting, masks/helmets optional).</p>
        <p class="hint">Optional live enroll capture mode: run inference with <code>--enroll-employee-id &lt;ID&gt; --enroll-kind face|reid</code>.</p>
        <pre id="enrollResult" class="output"></pre>
      </div>
    </section>

    <section id="tab-settings" class="tab">
      <div class="card">
        <div class="row-between">
          <h2>System Settings</h2>
          <button id="reloadSettingsBtn">Reload</button>
        </div>
        <form id="settingsForm" class="grid-form">
          <label>Face Threshold <input type="number" step="0.01" name="face_threshold" /></label>
          <label>ReID Threshold <input type="number" step="0.01" name="reid_threshold" /></label>
          <label>Standard Attendance Time (UTC) <input type="time" name="standard_attendance_time" /></label>
          <label>Morning Start <input type="time" name="morning_window_start" /></label>
          <label>Morning End <input type="time" name="morning_window_end" /></label>
          <label>Snapshot Retention Days <input type="number" min="0" name="snapshot_retention_days" /></label>
          <label>Save Snapshots Default
            <select name="save_snapshots_default">
              <option value="false">false</option>
              <option value="true">true</option>
            </select>
          </label>
          <label class="full">ROI Polygon (JSON)
            <textarea name="roi_polygon" rows="4"></textarea>
          </label>
          <label class="full">Entry Line (JSON)
            <textarea name="entry_line" rows="3"></textarea>
          </label>
          <button type="submit">Save Settings</button>
        </form>
        <pre id="settingsResult" class="output"></pre>
      </div>

      <div class="card">
        <h2>Add Camera</h2>
        <form id="cameraForm" class="grid-form">
          <label>Name <input name="name" required placeholder="Entrance Camera 1" /></label>
          <label>Camera Source <input name="rtsp_url" required placeholder="rtsp://... or webcam / webcam:0 / 0 / 1" /></label>
          <label>Location <input name="location" placeholder="Main Gate" /></label>
          <label>Enabled
            <select name="enabled">
              <option value="true">true</option>
              <option value="false">false</option>
            </select>
          </label>
          <button type="submit">Add Camera</button>
        </form>
      </div>

      <div class="card">
        <div class="row-between wrap">
          <h2>Camera Data</h2>
          <button id="refreshCamerasBtn" type="button">Refresh</button>
        </div>
        <p class="hint">Use RTSP URL for IP camera, or webcam source like <code>webcam</code>, <code>webcam:0</code>, <code>0</code>, <code>1</code>.</p>
        <table id="camerasTable">
          <thead>
            <tr>
              <th>ID</th><th>Name</th><th>RTSP URL</th><th>Location</th><th>Enabled</th><th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <div class="row-between wrap">
          <h2>Live Camera View</h2>
          <button id="stopCameraPreviewBtn" type="button">Stop View</button>
        </div>
        <p id="cameraPreviewHint" class="hint">Click <code>View</code> in Camera Data to show live stream with colored person rectangles and names.</p>
        <div class="camera-preview-wrap">
          <img id="cameraPreviewImg" alt="Camera live view" />
        </div>
      </div>
    </section>
  </main>

  <script src="/ui/app.js"></script>
</body>
</html>
